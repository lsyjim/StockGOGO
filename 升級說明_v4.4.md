# 量化交易系統 v4.4.4 升級說明

## 修正日期
2026-01-19

---

## 一、v4.4.4 關鍵邏輯修復

### 1.1 決策邏輯優先級修正（否決權機制）✅

**問題**：系統只要偵測到買進訊號就建議買進，忽略「場景A過熱」或「盈虧比不佳」的警告，導致報告矛盾

**修正**：重寫 `_generate_today_action_advice` 方法，引入否決權機制

**新邏輯優先級**：
```
賣出訊號（最高優先）
    ↓
過熱/濾網阻擋（否決權，次高優先）
    ↓
買進訊號（只有無阻擋時才成立）
    ↓
無訊號（最低優先）
```

**阻擋條件（Blockers）**：
| 條件 | 觸發 | 強制輸出 |
|------|------|----------|
| 過熱 | scenario == 'A' | ⚠️ 短線嚴重過熱，禁止追價 |
| 盈虧比差 | RR < 1.5 或無效 | ⏸️ 買進訊號觸發但風險過高 |
| 基本面風險 | PE<0 且 乖離>10% | ⚠️ 投機股風險警示 |
| RSI超買 | RSI > 80 | ⏸️ 短線回檔風險高 |

### 1.2 圖表訊號與報告同步 ✅

**問題**：K線圖綠色三角形判定過於寬鬆，與報告建議不一致

**修正**：在 `_detect_signals_for_chart` 加入濾網

```python
# 高檔爆量收黑 = 主力出貨跡象，取消買訊
is_distribution_bar = (vol_ratio > 2.5 and close < open_price)
if is_bull and golden_bias and golden_rsi:
    if not is_distribution_bar:  # 新增過濾
        buy_triggered = True
```

### 1.3 回測成本模型整合 ✅

**問題**：回測僅使用簡易滑價，結果過於樂觀

**修正**：回測引擎讀取 `QuantConfig` 計算完整成本

```python
def calculate_total_cost(slippage_pct=0.3):
    # 手續費（買進 + 賣出）
    commission_cost = QuantConfig.COMMISSION_RATE * 2  # 0.285%
    # 交易稅（僅賣出）
    tax_cost = QuantConfig.TAX_RATE  # 0.3%
    # 滑價
    slippage_cost = slippage_pct / 100  # 0.3%
    
    return commission_cost + tax_cost + slippage_cost  # 約 0.885%
```

### 1.4 API 錯誤防護強化 ✅

**問題**：WukongAPI 回傳 None 時程式崩潰

**修正**：
- `_load_data`: 加強 None 檢查，失敗時顯示錯誤訊息
- `_update_institutional_data`: 防護 data is None
- `_update_category_data`: 防護無效數據類型

---

## 二、v4.4.3 核心升級（先前）

### 1.1 總分上限修正 ✅

**問題**：總分計算可能超過 100 分（技術30 + 基本30 + 籌碼40 + 加分項）

**修正**：在 `_generate_recommendation` 和 `_generate_recommendation_v43` 中加入：
```python
score = max(0, min(100, score))  # Clamp score to 0-100
```

### 1.2 放寬黃金買點 RSI 限制 ✅

**修改**：`config.py` 中 `GOLDEN_BUY_RSI_MAX` 從 55 → 60

**原因**：原閾值對強勢股回檔過於嚴格

### 1.3 動態成交量閾值（Z-Score）✅

**問題**：固定倍數閾值對大型權值股（如台積電）難以觸發

**修正**：在 `VolumePriceAnalyzer` 中加入 Z-Score 計算：
```python
df['Vol_ZScore'] = (df['Volume'] - df['Vol_Mean']) / df['Vol_Std']
is_volume_spike = vol_zscore > QuantConfig.VOLUME_ZSCORE_SPIKE  # 2.5
is_heavy_volume = vol_zscore > QuantConfig.VOLUME_ZSCORE_HEAVY  # 3.0
```

### 1.4 布林通道帶寬壓縮警示 ✅

**新增**：在 `MarketRegimeAnalyzer` 中加入 Bollinger Bandwidth 計算

**功能**：當帶寬處於歷史低檔時，發出警示：
```
"⚠️ 波動率壓縮極致，即將變盤 (Volatility Squeeze - Potential Breakout Imminent)"
```

### 1.5 時間停損機制 ✅

**新增**：`RiskManager._assess_time_stop()` 方法

**規則**：若進場後 5 個交易日內股價未脫離成本區（獲利 < 0%），建議考慮出場

### 1.6 買賣點視覺化 ✅

**新增**：`StockAnalysisApp._detect_signals_for_chart()` 方法

**功能**：在 K 線圖上直接標示買賣訊號
- 🟢 綠色向上三角形（▲）：買進訊號
  - 三盤突破（連續3天收在 MA55 上方 + 突破前高）
  - 左側買訊（乖離 < -10% 且 RSI < 30）
  - 黃金買點（多頭 + 乖離回到 -5%~2% + RSI < 60）
  
- 🔴 紅色向下三角形（▼）：賣出訊號
  - 三盤跌破（連續3天收在 MA55 下方 + 跌破前低）
  - 左側賣訊（乖離 > 15% 且 RSI > 75）
  - 放量跌破（跌破 MA20 且成交量 > 2倍均量）

### 1.7 今日操作建議（開盤決策指引）✅

**新增**：`RecommendationDialog._generate_today_action_advice()` 方法

**功能**：在量化報告中顯示明確的開盤決策指引

**顯示內容**：
```
【🎯 今日操作建議】
📡 昨日訊號：🟢 買進訊號觸發 / 🔴 賣出訊號觸發 / ⚪ 無明確訊號
📌 今日建議：✅ 可買進 / 🔴 應賣出 / ⏸️ 觀望

✅ 執行條件檢核：
   ✓ 訊號觸發
   ✓ 盈虧比 ≥ 1.5
   ✓ 信心度
   ✓ 流動性

💰 關鍵價位：進場 / 停損 / 停利

🔔 結論：明確的執行建議
```

**判斷邏輯**：
- 訊號 + 場景 + 條件檢核 三者整合
- 4/4 條件通過 → 執行買進
- 3/4 條件通過 → 小量試單
- <3 條件通過 → 等待更佳時機

---

## 二、v4.4.2 修正（先前）

### 1.1 修復 Tkinter callback race condition ✅

**問題**：當使用者關閉「市場排行」彈窗後，背景執行緒的結果到達時會噴 `TclError: invalid command name`

**解決方案**：
- 新增 `_closed` 關閉旗標
- 新增 `_after_ids` 紀錄所有 `after` callback id
- 綁定 `WM_DELETE_WINDOW` 到 `_on_close()`
- 新增 `_safe_after(ms, func)` 和 `_safe_ui_update(func)` 方法
- 所有 UI 更新方法加入 `winfo_exists()` 檢查和 `TclError` 捕捉

### 1.2 修復籌碼信號判斷 ✅

**問題**：籌碼面信號使用中文句子硬比對（如「連續買超」），API 文案差異導致永遠不觸發

**解決方案**：
```python
# 舊方式（已棄用）
if chip.get("foreign_continuous") == "連續買超"

# 新方式（數值驅動）
foreign_net = chip.get("foreign_net", 0)
trust_net = chip.get("trust_net", 0)
foreign_days = chip.get("foreign_consecutive_days", 0)
trust_days = chip.get("trust_consecutive_days", 0)

is_sync_buy = (foreign_net > 0 and trust_net > 0 and 
               foreign_days >= 2 and trust_days >= 2)
```

**新增數值欄位**（TWSE 和悟空 API 都已補齊）：
- `foreign_net`：外資淨買超金額
- `trust_net`：投信淨買超金額
- `foreign_consecutive_days`：外資連續買/賣超天數（正=買，負=賣）
- `trust_consecutive_days`：投信連續買/賣超天數

### 1.3 悟空 API 籌碼查詢修正 ✅

**問題**：解析格式錯誤，導致數據全部是 0

**根因**：API 回應格式與假設不同
- 實際格式：`{"iibs": [...]}`，不是直接的 list
- 欄位名稱：`foreignInvestorsBuySell`、`investmentTrustBuySell`、`dealerBuySell`
- 日期欄位：`inputDate`
- 數值單位：**張數**（不是股數）

**實際 API 回應格式**：
```json
{
  "iibs": [
    {
      "inputDate": "2026-01-16",
      "foreignInvestorsBuySell": 10105,    // 外資買賣超（張數）
      "investmentTrustBuySell": 208,        // 投信買賣超（張數）
      "dealerBuySell": -1134,               // 自營商買賣超（張數）
      "total": 9179
    }
  ]
}
```

**修正後的解析邏輯**：
```python
iibs_list = data.get('iibs', [])
latest = sorted(iibs_list, key=lambda x: x.get('inputDate', ''), reverse=True)[0]
foreign_net = latest.get('foreignInvestorsBuySell', 0)  # 張數
trust_net = latest.get('investmentTrustBuySell', 0)
dealer_net = latest.get('dealerBuySell', 0)
```

**新增功能**：連續天數自動計算
- 遍歷歷史數據，計算外資/投信連續同方向的天數
- 例如：外資連續3天買超 → `foreign_consecutive_days = 3`

### 1.4 自選股「刷新」按鈕 ✅

**修改**：將「📊 相關性」按鈕替換為「🔄 刷新分析」按鈕

**功能**：
1. 取得目前自選股清單
2. 逐一執行每支股票的量化分析（呼叫現有 `QuickAnalyzer.analyze_stock()`）
3. 每完成一支更新進度標籤（顯示「刷新中：3/10 (2330)」）
4. 加入節流延遲（0.3秒/檔）降低 API 壓力
5. 全部完成後顯示結果 messagebox
6. 若有失敗則彙整錯誤清單

**新增方法**：
- `refresh_all_watchlist_analysis()`：批次刷新主邏輯
- `_update_progress(text)`：更新進度標籤
- `_safe_ui_update(func)`：安全的 UI 更新包裝器

### 1.5 籌碼面顯示增強 ✅

**問題**：原本籌碼面只顯示文字，無法看出具體數值和連續天數

**解決方案**：增強量化分析報告和下單頁面的籌碼面顯示

**報告顯示樣貌**：
```
● 籌碼面分析
  資料來源：悟空API
  🔴 外資：連3日買超 (1.25億) （連3日買超）
  🔴 投信：買超 (0.35億)
  ⭐ 同步買超信號：外資投信同步連續買超，籌碼面強勢
  籌碼結論：籌碼集中
  最新資料日期：2026-01-17（悟空API）
```

**數值驅動判斷**：
- 🔴 買超：`foreign_net > 0` 或 `trust_net > 0`
- 🟢 賣超：`foreign_net < 0` 或 `trust_net < 0`
- ⚪ 觀望：`foreign_net == 0` 或 `trust_net == 0`
- ⭐ 同步買超信號：外資投信都買超且連續天數>=2
- ⚠️ 同步賣超風險：外資投信都賣超且連續天數>=2

### 1.6 PE 負值處理修正 ✅

**問題**：當 PE 為負值（公司虧損）時，`forward_pe < 12` 判斷會錯誤觸發「長線看好」

**修正內容**：

1. **長線建議函數 `_get_long_term_recommendation()`**：
   - 新增 PE 負值檢查
   - PE 為負時，改用 PB（股價淨值比）判斷
   - 若無 PB，則參考技術面和籌碼面

2. **基本面分析函數 `_analyze_fundamental()`**：
   - PE 負值時跳過 PE 判斷
   - 改用 PB 作為替代指標
   - signal_reason 顯示「公司虧損」提示

3. **報告顯示**：
   - PE 為負時顯示 ⚠️ 警告標記

**PE 負值時的長線建議邏輯**：
```python
if pe_is_negative:
    if pb < 1.0:
        return "長線觀察" # 股價低於淨值，可關注轉機
    elif pb < 2.0:
        return "長線謹慎" # 需觀察獲利改善
    else:
        return "長線避開" # PB偏高，風險大
```

---

## 二、PE 為負值說明

### 問題
6770 力積電的報告顯示「預估PE：-138.53」

### 原因
**Forward PE 計算公式：**
```
Forward PE = 當前股價 / 預估未來12個月 EPS
```

當公司**預估未來虧損（EPS 為負）**時，PE 會是負值：
```
Forward PE = 56.4 / (-0.407) ≈ -138.5
```

### 這不是程式錯誤
- 這是 Yahoo Finance API 直接回傳的數據
- 力積電預估未來 12 個月的 EPS 為負值（虧損）
- 負 PE 在財務上無意義，系統會自動降低其判斷權重

### 驗證方式
執行 `api_verify_6770.py` 可驗證：
```bash
python api_verify_6770.py
```

---

## 三、下單頁面 UI 修正

### 1.1 股票代號前導 0 問題 ✅ (v4.4.1 最終修正)
**問題**：點擊庫存明細中的 0056 時，委託下單欄位只顯示 56
**根因**：Treeview 將字串型數字自動轉為整數
**解決方案**：使用 `iid` 保存原始股票代號

```python
# 插入時使用 iid 存儲
iid = f"inv_{idx}_{symbol_str}"
inventory_tree.insert('', 'end', iid=iid, values=(...))

# 讀取時從 iid 提取
if iid.startswith('inv_'):
    parts = iid.split('_')
    sym_str = '_'.join(parts[2:])
    symbol_var.set(sym_str)
```

### 1.2 股票名稱顯示 ✅
- 從富邦行情 API 取得股票名稱

### 1.3 零股顯示 ✅
- 處理庫存 API 的 `odd` 欄位
- 顯示格式：`2,500(2000+500)`

---

## 二、籌碼面數據改用悟空 API ✅

### 2.1 API 整合
**API**: `https://api.wukong.com.tw/stock/{stockId}/iibs`

新增 `_analyze_chip_flow_wukong()` 方法：
- 優先使用悟空 API 取得籌碼資料
- 包含外資、投信、自營商的買賣超和連續買賣超天數
- 失敗時自動 fallback 到 TWSE API

**回傳欄位**：
```json
{
  "available": true,
  "data_source": "悟空API",
  "foreign": "連3日買超 (1.25億)",
  "trust": "買超 (0.35億)",
  "dealer": "賣超 (0.12億)",
  "foreign_consecutive_days": 3,
  "trust_consecutive_days": 1,
  "signal": "籌碼集中",
  "signal_color": "positive"
}
```

---

## 三、量價分析整合到決策矩陣 ✅

### 3.1 決策變數新增
在 `DecisionMatrix._calculate_decision_variables()` 中加入：

```python
'volume_price': {
    'available': True,
    'vp_score': 30,
    'signals': [...],
    'high_risk_signals': [...],
    'has_breakdown': False,      # VP08 放量跌破
    'has_supply_overhang': False, # VP07 放量不漲
    'has_valid_breakout': True,  # VP05 帶量突破
    'has_gap_down': False        # VP12 跳空下跌
}
```

### 3.2 濾網新增
在 `DecisionMatrix._apply_filters()` 中加入量價分析濾網：

| 濾網代碼 | 觸發條件 | 動作 |
|---------|---------|------|
| VP_BREAKDOWN | 放量跌破(VP08) + 買進訊號 | 強制降級為賣出 |
| VP_GAP_DOWN | 跳空下跌帶量(VP12) + 買進訊號 | 強制降級為賣出 |
| VP_SUPPLY_OVERHANG | 放量不漲(VP07) + 買進訊號 | 降級為觀望 |
| VP_MULTIPLE_RISK | 多個高風險訊號(≥2) | 降低信心度 |
| LIQUIDITY_GATE | 流動性不足 | 降級為觀望 |

**帶量突破(VP05)** 會增加買進信心度至 High

### 3.3 報告新增段落
在量化分析報告中新增：

**【📊 量價分析情境庫 v4.4】**
- 量價摘要與分數
- 觸發的情境（最多5個）
- 每個情境包含：名稱、嚴重度、證據、決策建議
- 量價決策提示
- 風險提示

**【🛡️ 風險管理分析 v4.4】**
- 進場價/停損/停利
- ATR 和風險回報比
- 流動性評估
- 跳空風險
- 建議倉位
- 可交易性判斷

---

## 四、修改的檔案摘要

### fubon_trading.py
- `refresh_inventory()`: 使用 iid 存儲股票代號
- `on_inventory_select()`: 從 iid 提取股票代號，保留前導0

### main.py
- `_analyze_chip_flow_cached()`: 優先使用悟空 API
- `_analyze_chip_flow_wukong()`: 新增悟空 API 籌碼分析
- `analyze_stock()`: 加入量價分析和風險管理
- `RecommendationDialog._insert_analysis()`: 新增量價分析和風險管理報告段落

### analyzers.py
- `DecisionMatrix._calculate_decision_variables()`: 加入量價分析因子
- `DecisionMatrix._get_volume_price_factors()`: 新增量價因子提取
- `DecisionMatrix._apply_filters()`: 加入量價分析濾網

### config.py
- 新增量價分析、風險管理、流動性過濾相關參數

---

## 五、量價分析情境對決策的影響

| 情境 | 代碼 | 對決策的影響 |
|-----|------|-------------|
| 價漲量增 | VP01 | 確認多頭，增加信心 |
| 價漲量縮 | VP02 | 警示弱勢上漲 |
| 價跌量增 | VP03 | 空頭確認，風控優先 |
| 價跌量縮 | VP04 | 可能止跌前兆 |
| 帶量突破 | VP05 | **增加買進信心至 High** |
| 無量突破 | VP06 | 警示假突破 |
| 放量不漲 | VP07 | **買進訊號降級為觀望** |
| 放量跌破 | VP08 | **強制降級為賣出** |
| 吸籌跡象 | VP09 | 支持分批布局 |
| 出貨跡象 | VP10 | 逢高減碼 |
| 跳空上漲帶量 | VP11 | 追隨但縮倉 |
| 跳空下跌帶量 | VP12 | **強制降級為賣出** |

---

## 六、使用說明

1. 將所有檔案複製到專案目錄
2. 重新啟動程式
3. 查詢股票時會自動執行量價分析和風險管理
4. 報告中會顯示觸發的量價情境及其對決策的影響
